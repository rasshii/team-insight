# infrastructure/docker/backend/supervisord.conf
# Supervisord設定ファイル - Laravel本番環境用
#
# Supervisordは、複数のプロセスを管理・監視するツールです。
# プロセスが異常終了した場合、自動的に再起動することで
# アプリケーションの可用性を高めます。

[supervisord]
# フォアグラウンドで実行（Dockerコンテナ用）
nodaemon=true

# ユーザー（root権限で実行）
user=root

# ログファイル
logfile=/var/log/supervisor/supervisord.log

# プロセスIDファイル
pidfile=/var/run/supervisord.pid

# 子プロセスのログファイルサイズ
childlogdir=/var/log/supervisor

# ログレベル
# critical, error, warn, info, debug
loglevel=info

# ===========================================
# supervisorctl設定
# ===========================================
[supervisorctl]
# supervisorctlコマンドの設定
serverurl=unix:///var/run/supervisor.sock

# ===========================================
# unix_http_server設定
# ===========================================
[unix_http_server]
# Unixソケットファイル
file=/var/run/supervisor.sock

# ソケットファイルの権限
chmod=0700

# ===========================================
# rpcinterface設定
# ===========================================
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# ===========================================
# PHP-FPMプロセス
# ===========================================
[program:php-fpm]
# 実行コマンド
command=/usr/local/sbin/php-fpm

# 自動起動
autostart=true

# 異常終了時の自動再起動
autorestart=true

# 標準出力ログ
stdout_logfile=/var/log/supervisor/php-fpm.log

# エラーログ
stderr_logfile=/var/log/supervisor/php-fpm-error.log

# ===========================================
# Laravelキューワーカー
# ===========================================
[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/html/artisan queue:work --sleep=3 --tries=3
autostart=true
autorestart=true
numprocs=2
redirect_stderr=true
stdout_logfile=/var/log/supervisor/worker.log

# ===========================================
# Laravel高優先度キューワーカー
# ===========================================
[program:laravel-queue-high]
# 高優先度キュー専用のワーカー
command=/usr/local/bin/php /var/www/html/artisan queue:work redis --sleep=1 --tries=5 --timeout=60 --queue=high

user=www-data
autostart=true
autorestart=true
priority=15
numprocs=1
process_name=%(program_name)s_%(process_num)02d

stdout_logfile=/var/log/supervisor/laravel-queue-high.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5

stderr_logfile=/var/log/supervisor/laravel-queue-high-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5

startsecs=10
startretries=3
stopsignal=TERM
stopwaitsecs=120
stopasgroup=true
killasgroup=true

# ===========================================
# Laravelタスクスケジューラー
# ===========================================
[program:laravel-scheduler]
# Laravelのスケジュールコマンドを毎分実行
command=/bin/sh -c 'while true; do /usr/local/bin/php /var/www/html/artisan schedule:run >> /var/log/scheduler.log 2>&1; sleep 60; done'

user=www-data
autostart=true
autorestart=true
priority=30
numprocs=1

stdout_logfile=/var/log/supervisor/laravel-scheduler.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5

stderr_logfile=/var/log/supervisor/laravel-scheduler-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5

# ===========================================
# Laravel Horizon（オプション：高度なキュー管理）
# ===========================================
; [program:laravel-horizon]
; command=/usr/local/bin/php /var/www/html/artisan horizon
; user=www-data
; autostart=true
; autorestart=true
; priority=25
; stdout_logfile=/var/log/supervisor/laravel-horizon.log
; stderr_logfile=/var/log/supervisor/laravel-horizon-error.log
; stopwaitsecs=3600

# ===========================================
# グループ設定
# ===========================================
[group:laravel-workers]
# Laravelワーカーをグループ化して管理
programs=laravel-queue-high,laravel-scheduler
priority=20
