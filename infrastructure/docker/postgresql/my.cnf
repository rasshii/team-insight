# infrastructure/docker/mysql/my.cnf
# MySQL 8.0設定ファイル - Mine-CMS開発環境用
#
# このファイルは、MySQLサーバーの動作を制御する設定を定義します。
# 開発環境用に最適化されており、本番環境では別の設定が必要です。

[mysqld]
# ===========================================
# 基本設定
# ===========================================
# サーバーIDの設定（レプリケーション使用時に重要）
server-id = 1

# ポート番号
port = 3306

# ソケットファイルの場所
socket = /var/run/mysqld/mysqld.sock

# データディレクトリ
datadir = /var/lib/mysql

# プロセスIDファイル
pid-file = /var/run/mysqld/mysqld.pid

# ===========================================
# 文字コード設定（日本語対応に重要）
# ===========================================
# デフォルトの文字セットをutf8mb4に設定
# utf8mb4は、絵文字を含む全てのUnicode文字を扱えます
character-set-server = utf8mb4

# 照合順序の設定
# utf8mb4_unicode_ciは、多言語対応に優れています
collation-server = utf8mb4_unicode_ci

# クライアントからの接続時のデフォルト文字セット
init-connect = 'SET NAMES utf8mb4'

# ===========================================
# 接続設定
# ===========================================
# 最大同時接続数
# 開発環境では少なめに設定
max_connections = 200

# 接続タイムアウト（秒）
connect_timeout = 10

# 接続を待機する秒数
wait_timeout = 28800

# インタラクティブ接続のタイムアウト
interactive_timeout = 28800

# ===========================================
# バッファとキャッシュの設定
# ===========================================
# InnoDBバッファプールサイズ
# 利用可能メモリの50-70%程度を割り当てるのが一般的
innodb_buffer_pool_size = 1G

# InnoDBログファイルサイズ
# 大きいほどパフォーマンスが向上しますが、クラッシュリカバリが遅くなります
innodb_log_file_size = 256M

# InnoDBログバッファサイズ
innodb_log_buffer_size = 64M

# クエリキャッシュ（MySQL 8.0では非推奨）
# query_cache_type = 0
# query_cache_size = 0

# テンポラリテーブルの最大サイズ
tmp_table_size = 64M
max_heap_table_size = 64M

# ソートバッファサイズ
sort_buffer_size = 4M

# 読み取りバッファサイズ
read_buffer_size = 2M
read_rnd_buffer_size = 8M

# 結合バッファサイズ
join_buffer_size = 8M

# ===========================================
# InnoDB設定
# ===========================================
# ファイルあたりのテーブル保存
# 各テーブルを個別のファイルに保存（管理が容易）
innodb_file_per_table = 1

# ダブルライトバッファ
# データの整合性を保つが、パフォーマンスに影響
innodb_doublewrite = 1

# フラッシュ方法
# O_DIRECTはLinuxで推奨される設定
innodb_flush_method = O_DIRECT

# トランザクションログのフラッシュ頻度
# 1 = 各トランザクション後（最も安全）
# 2 = 毎秒（パフォーマンスと安全性のバランス）
innodb_flush_log_at_trx_commit = 2

# ===========================================
# ログ設定
# ===========================================
# エラーログ
log_error = /var/log/mysql/error.log

# 一般クエリログ（開発環境でのデバッグ用）
general_log = 1
general_log_file = /var/log/mysql/general.log

# スロークエリログ
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

# インデックスを使用しないクエリもログに記録
log_queries_not_using_indexes = 1

# ===========================================
# バイナリログ設定（バックアップとレプリケーション用）
# ===========================================
# バイナリログを有効化
log_bin = /var/log/mysql/mysql-bin.log

# バイナリログの有効期限（日数）
binlog_expire_logs_seconds = 604800  # 7日間

# バイナリログフォーマット
binlog_format = ROW

# ===========================================
# セキュリティ設定
# ===========================================
# シンボリックリンクを無効化（セキュリティ向上）
symbolic-links = 0

# LOAD DATA INFILEの無効化（セキュリティ向上）
local_infile = 0

# ===========================================
# パフォーマンススキーマ設定
# ===========================================
# パフォーマンススキーマを有効化（パフォーマンス分析用）
performance_schema = ON

# ===========================================
# 開発環境固有の設定
# ===========================================
# SQLモード（開発環境では緩めに設定）
sql_mode = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'

# 外部からの接続を許可（開発環境のみ）
bind-address = 0.0.0.0

[mysql]
# クライアントのデフォルト文字セット
default-character-set = utf8mb4

[mysqldump]
# mysqldumpのデフォルト文字セット
default-character-set = utf8mb4

# シングルトランザクションでダンプ（整合性確保）
single-transaction

# ルーティンもダンプに含める
routines

# トリガーもダンプに含める
triggers
